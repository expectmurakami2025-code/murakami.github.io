
<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ã‚¬ãƒ©ã‚¬ãƒ©çƒå ã„</title>
<style>
  body{font-family:system-ui,-apple-system,"Segoe UI",Meiryo,Arial,sans-serif;text-align:center;background:#fafafa;margin:0;padding:24px}
  h1{margin:0 0 6px}
  .muted{color:#666}
  .stage-wrap{position:relative;display:inline-block}
  #videoCanvas{background:transparent;cursor:pointer;border-radius:12px;box-shadow:0 4px 18px rgba(0,0,0,.08)}
  .checker{position:absolute;inset:0;background:conic-gradient(#eee 0 25%,#ddd 0 50%,#eee 0 75%,#ddd 0 100%);background-size:24px 24px;opacity:.45;pointer-events:none;border-radius:12px}
  #hoverHint{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);padding:8px 12px;background:rgba(255,255,255,.92);border:1px solid #dfe3f0;border-radius:10px;font-size:14px;color:#333;display:none;pointer-events:none;white-space:nowrap}
  ruby rt{font-size:.7em;color:#444}

  #fortune{white-space:normal;margin:14px auto;max-width:520px;text-align:left;background:#fff;border:1px dashed #ccd;padding:12px;border-radius:10px;line-height:1.7}
  #fortune .line{margin:.25em 0}
  #fortune .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
  .history-item{border-top:1px solid #e8e8e8;padding:8px 0;text-align:left;max-width:520px;margin:0 auto}
  #clearHistory{margin-top:10px;padding:6px 12px;border:1px solid #cfd3e1;background:#f8f9ff;border-radius:8px;cursor:pointer}
  #clearHistory:hover{background:#eef2ff}
</style>
</head>
<body>

<h1>ã‚¬ãƒ©ã‚¬ãƒ©çƒå ã„</h1>
<p>â†“ã‚’<ruby>é•·æŠ¼<rt>ãªãŒãŠ</rt></ruby>ã—ã—ã¦ã€ã¯ãªã™ã¨ã€ŒãŠã¿ãã˜ã€ã®ç‰ãŒå‡ºã¾ã™ã€‚</p>
<div class="stage-wrap" id="stageWrap" title="ã“ã“ã‚’ãªãŒãŠã—ã—ã¦ã€ã¯ãªã™ã¨ã€ŒãŠã¿ãã˜ã€ã®ç‰ãŒå‡ºã¾ã™ã€‚">
  <canvas id="videoCanvas" width="300" height="300"></canvas>
  <div class="checker"></div>
</div>

<div id="fortune">ï¼ˆã“ã“ã«å ã„çµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™ï¼‰</div>

<!-- å±¥æ­´ã¨å‰Šé™¤ãƒœã‚¿ãƒ³ -->
<button id="clearHistory">å±¥æ­´ã‚’å‰Šé™¤</button>
<div id="history"></div>

<!-- éè¡¨ç¤ºã®å‹•ç”»ï¼ˆéŸ³å£°ãªã—ï¼‰ -->
<video id="src" src="garagara.mp4" playsinline preload="auto" style="display:none"></video>

<script>
/* ===== è¨­å®šãƒ»çŠ¶æ…‹ ===== */
const LOOP_START = 0.0;
const LOOP_END   = 1.0;
let spinning=false, playing=false, shouldShowFortune=false, rafId=null;

/* ===== ãµã‚ŠãŒãªè¾æ›¸ ===== */
const RUBIES = [
  ["èª­æ›¸","ã©ãã—ã‚‡"],["ç®—æ•°","ã•ã‚“ã™ã†"],["æ¼¢å­—","ã‹ã‚“ã˜"],["ç†ç§‘","ã‚Šã‹"],["äººç‰©","ã˜ã‚“ã¶ã¤"],["è‹±èª","ãˆã„ã”"],
  ["ç™»å ´äººç‰©","ã¨ã†ã˜ã‚‡ã†ã˜ã‚“ã¶ã¤"],["æ€§æ ¼","ã›ã„ã‹ã"],["è¨€è‘‰","ã“ã¨ã°"],["æ„å‘³","ã„ã¿"],["æ„Ÿæƒ³","ã‹ã‚“ãã†"],["éŸ³èª­","ãŠã‚“ã©ã"],
  ["å ´é¢","ã°ã‚ã‚“"],["ç« ","ã—ã‚‡ã†"],["äºˆæƒ³","ã‚ˆãã†"],["è¡¨ç´™","ã²ã‚‡ã†ã—"],["ç†ç”±","ã‚Šã‚†ã†"],
  ["è¨ˆç®—","ã‘ã„ã•ã‚“"],["åˆè¨ˆ","ã”ã†ã‘ã„"],["æš—ç®—","ã‚ã‚“ã–ã‚“"],["ä¹ä¹","ãã"],["å›³å½¢","ãšã‘ã„"],["æ£’ã‚°ãƒ©ãƒ•","ã¼ã†ã‚°ãƒ©ãƒ•"],
  ["å‰²ã‚Šç®—","ã‚ã‚Šã–ã‚“"],["ç­†ç®—","ã²ã£ã•ã‚“"],["æ™‚é–“","ã˜ã‹ã‚“"],["é‡ã•","ãŠã‚‚ã•"],["åˆ†æ•°","ã¶ã‚“ã™ã†"],
  ["åŒéŸ³ç•°ç¾©èª","ã©ã†ãŠã‚“ã„ãã”"],["ä¾‹æ–‡","ã‚Œã„ã¶ã‚“"],["éƒ¨é¦–","ã¶ã—ã‚…"],["ç”±æ¥","ã‚†ã‚‰ã„"],["æˆã‚Šç«‹ã¡","ãªã‚ŠãŸã¡"],
  ["æ¤ç‰©","ã—ã‚‡ãã¶ã¤"],["è¦³å¯Ÿ","ã‹ã‚“ã•ã¤"],["è¨˜éŒ²","ãã‚ã"],["å¤©æ°—","ã¦ã‚“ã"],["æ–¹è§’","ã»ã†ãŒã"],["ç£çŸ³","ã˜ã—ã‚ƒã"],
  ["å¤ªé™½","ãŸã„ã‚ˆã†"],["ä½ç½®","ã„ã¡"],["å½±","ã‹ã’"],["åˆ†é¡","ã¶ã‚“ã‚‹ã„"],["æˆé•·","ã›ã„ã¡ã‚‡ã†"],["æ˜Ÿåº§","ã›ã„ã–"],
  ["æ™‚ä»£","ã˜ã ã„"],["å‡ºæ¥äº‹","ã§ãã”ã¨"],["å¹´è¡¨","ã­ã‚“ã´ã‚‡ã†"],["åœ°å›³","ã¡ãš"],["åè¨€","ã‚ã„ã’ã‚“"],["åŒæ™‚ä»£","ã©ã†ã˜ã ã„"],["å…±é€šç‚¹","ãã‚‡ã†ã¤ã†ã¦ã‚“"],
  ["ä¼¼é¡”çµµ","ã«ãŒãŠãˆ"],["è³ªå•","ã—ã¤ã‚‚ã‚“"],["é–¢é€£","ã‹ã‚“ã‚Œã‚“"],["æ–°äº‹å®Ÿ","ã—ã‚“ã˜ã˜ã¤"],["ç®‡æ¡æ›¸ã","ã‹ã˜ã‚‡ã†ãŒã"],
  ["è‹±å˜èª","ãˆã„ãŸã‚“ã”"],["è‹±æ–‡","ãˆã„ã¶ã‚“"],["è‡ªå·±ç´¹ä»‹","ã˜ã“ã—ã‚‡ã†ã‹ã„"],["ç™ºéŸ³","ã¯ã¤ãŠã‚“"],["æ•°å­—","ã™ã†ã˜"],["æ™‚åˆ»","ã˜ã“ã"],["å‹•è©","ã©ã†ã—"]
];
const rubyMap=new Map(RUBIES);
function applyRuby(str){
  let out=str;
  const keys=[...rubyMap.keys()].sort((a,b)=>b.length-a.length);
  for(const k of keys){
    const rt=rubyMap.get(k);
    out=out.replace(new RegExp(k,"g"), `<ruby><rb>${k}</rb><rt>${rt}</rt></ruby>`);
  }
  return out;
}

/* ===== å ã„ãƒ‡ãƒ¼ã‚¿ï¼ˆå°å­¦ç”Ÿå‘ã‘ãƒŸãƒƒã‚·ãƒ§ãƒ³ï¼‰ ===== */
const SUBJECTS=["èª­æ›¸","ç®—æ•°","æ¼¢å­—","ç†ç§‘","äººç‰©ã®ãƒã‚¿","è‹±èª"];
const LEVEL_LABEL={1:"ã‚„ã•ã—ã„",2:"ãµã¤ã†",3:"ãƒãƒ£ãƒ¬ãƒ³ã‚¸"};
const SUBJECT_MISSIONS = {
  "èª­æ›¸":[
    {text:"å¥½ããªæœ¬ã‚’5åˆ†ã ã‘èª­ã‚‚ã†ã€‚èª­ã‚“ã ãƒšãƒ¼ã‚¸ã‚’ãƒ¡ãƒ¢ã™ã‚‹ã€‚",level:1,minutes:5},
    {text:"ç™»å ´äººç‰©ã‚’1äººãˆã‚‰ã³ã€ã™ããªã¨ã“ã‚ã‚’1è¡Œæ›¸ã“ã†ã€‚",level:1,minutes:6},
    {text:"çŸ¥ã‚‰ãªã„è¨€è‘‰ã‚’1ã¤è¦‹ã¤ã‘ã¦ã€æ„å‘³ã‚’ã—ã‚‰ã¹ã‚ˆã†ã€‚",level:1,minutes:6},
    {text:"ä»Šæ—¥ãŠã‚‚ã—ã‚ã‹ã£ãŸæ–‡ã‚’1ã¤æ›¸ãå†™ã—ã¦ã¿ã‚ˆã†ã€‚",level:2,minutes:7},
    {text:"éŸ³èª­ã‚’1ãƒšãƒ¼ã‚¸ã—ã¦ã€ã‚†ã£ãã‚Šã¯ã£ãã‚Šèª­ã‚€ã€‚",level:1,minutes:5},
    {text:"ãŠè©±ã®ã¯ã˜ã¾ã‚Šãƒ»ãªã‹ãƒ»ãŠã‚ã‚Šã‚’1è¡Œãšã¤æ›¸ãã€‚",level:2,minutes:8},
    {text:"ã¤ã¥ãã®äºˆæƒ³ã‚’2è¡Œã§æ›¸ã„ã¦ã¿ã‚ˆã†ã€‚",level:2,minutes:8},
    {text:"ç™»å ´äººç‰©ã®æ°—ã‚‚ã¡ã‚’1ã¤æƒ³åƒã—ã¦æ›¸ã“ã†ã€‚",level:2,minutes:7},
    {text:"è¡¨ç´™ã®çµµã®ã„ã„ã¨ã“ã‚ã‚’3ã¤è¦‹ã¤ã‘ã‚ˆã†ã€‚",level:1,minutes:5},
    {text:"å‹ã ã¡ã«ãŠã™ã™ã‚ã—ãŸã„ç†ç”±ã‚’2ã¤æ›¸ã“ã†ã€‚",level:3,minutes:10}
  ],
  "ç®—æ•°":[
    {text:"è¨ˆç®—ï¼ˆãŸã—ã–ã‚“ãƒ»ã²ãã–ã‚“ï¼‰ã‚’3å•ã‚„ã£ã¦ã¿ã‚ˆã†ã€‚",level:1,minutes:5},
    {text:"ä¹ä¹ã‚’1ã ã‚“ã ã‘å£°ã«å‡ºã—ã¦è¨€ã£ã¦ã¿ã‚ˆã†ã€‚",level:1,minutes:5},
    {text:"å®¶ã®ä¸­ã§ã€Œä¸¸ãƒ»ä¸‰è§’ãƒ»å››è§’ã€ã‚’1ã¤ãšã¤è¦‹ã¤ã‘ã‚‹ã€‚",level:1,minutes:6},
    {text:"ã•ã„ãµã®å°éŠ­ã§100å††ã«ãªã‚‹çµ„ã¿ã‚ã‚ã›ã‚’ä½œã‚‹ã€‚",level:2,minutes:7},
    {text:"é•·ã•ã‚’ã‚‚ã®ã•ã—ã§1ã‹æ‰€ã¯ã‹ã£ã¦ãƒ¡ãƒ¢ã™ã‚‹ã€‚",level:2,minutes:7},
    {text:"1æ—¥ã®ç”Ÿæ´»ã§æ•°ãŒå‡ºã‚‹å ´é¢ã‚’1ã¤è¦‹ã¤ã‘ã¦æ›¸ãã€‚",level:1,minutes:5},
    {text:"å›³å½¢ã®è¾ºã®æ•°ã‚’ã‹ããˆã¦ã€ã¡ãŒã„ã‚’æ›¸ã“ã†ã€‚",level:2,minutes:8},
    {text:"ã¾ã¡ãŒãˆãŸå•é¡Œã‚’1ã¤ãˆã‚‰ã³ã€ã©ã“ã§ãƒŸã‚¹ã‹æ›¸ãã€‚",level:3,minutes:9},
    {text:"åˆ†æ•°(1/2ãªã©)ã®ä¾‹ã‚’1ã¤èº«è¿‘ã§è¦‹ã¤ã‘ã‚ˆã†ã€‚",level:2,minutes:7},
    {text:"æ™‚è¨ˆã‚’è¦‹ã¦ã€ã„ã¾ã®æ™‚åˆ»ã¨10åˆ†å¾Œã®æ™‚åˆ»ã‚’æ›¸ãã€‚",level:1,minutes:5}
  ],
  "æ¼¢å­—":[
    {text:"æ–°ã—ã„æ¼¢å­—ã‚’2ã“ã€æ­£ã—ã„æ›¸ãé †ã§æ›¸ã“ã†ã€‚",level:1,minutes:6},
    {text:"åŒã˜éƒ¨é¦–ã®æ¼¢å­—ã‚’3ã“é›†ã‚ã¦ãªã‚‰ã¹ã‚ˆã†ã€‚",level:2,minutes:8},
    {text:"ãªã‚‰ã£ãŸæ¼¢å­—ã§çŸ­æ–‡ã‚’2ã¤ä½œã£ã¦æ›¸ã“ã†ã€‚",level:2,minutes:8},
    {text:"ã«ã¦ã„ã‚‹æ¼¢å­—2ã¤ã®ã¡ãŒã„ã‚’1è¡Œã§èª¬æ˜ã—ã‚ˆã†ã€‚",level:3,minutes:9},
    {text:"é€ã‚ŠãŒãªã«æ°—ã‚’ã¤ã‘ã¦ã“ã¨ã°ã‚’3ã¤æ›¸ã“ã†ã€‚",level:2,minutes:7},
    {text:"ç†Ÿèªã‚’3ã¤ãˆã‚‰ã³ã€èª­ã¿ã‚’ã‹ã“ã†ã€‚",level:1,minutes:6},
    {text:"æ›¸ãå–ã‚Šã‚’1è¡Œã ã‘ã€ã‚†ã£ãã‚Šã¦ã„ã­ã„ã«æ›¸ãã€‚",level:1,minutes:5},
    {text:"ä»Šæ—¥ã®æ¼¢å­—1ã¤ã§ã€ã“ã¨ã°ã‚’3ã¤ä½œã‚ã†ã€‚",level:2,minutes:7},
    {text:"å¥½ããªæ¼¢å­—ã®æ„å‘³ã‚„ç”±æ¥ã‚’1ã¤ã—ã‚‰ã¹ã‚‹ã€‚",level:3,minutes:10},
    {text:"éƒ¨é¦–ã¨ç”»æ•°ã‚’1ã¤ã—ã‚‰ã¹ã¦ãƒãƒ¼ãƒˆã«æ›¸ã“ã†ã€‚",level:2,minutes:7}
  ],
  "ç†ç§‘":[
    {text:"å¤–ã‚„ãƒ™ãƒ©ãƒ³ãƒ€ã®æ¤ç‰©ã‚’1ã¤è¦‹ã¤ã‘ã¦ã€è‘‰ã®å½¢ã‚’ã‚¹ã‚±ãƒƒãƒã€‚",level:1,minutes:8},
    {text:"æ°´ã«ã†ãã‚‚ã®ï¼ã—ãšã‚€ã‚‚ã®ã‚’1ã¤ãšã¤èª¿ã¹ã‚‹ã€‚",level:1,minutes:7},
    {text:"ä»Šæ—¥ã®å¤©æ°—ã‚’3èªã§ãƒ¡ãƒ¢ã—ã€æ˜æ—¥ã®äºˆæƒ³ã‚’1è¡Œã€‚",level:1,minutes:6},
    {text:"ã‹ã’ã®é•·ã•ã‚’1å›ã¯ã‹ã£ã¦ãƒ¡ãƒ¢ã™ã‚‹ã€‚",level:2,minutes:7},
    {text:"ç£çŸ³ã§ãã£ã¤ãã‚‚ã®ã‚’2ã¤è¦‹ã¤ã‘ã‚ˆã†ã€‚",level:2,minutes:7},
    {text:"èº«è¿‘ãªç”Ÿãç‰©ã®ã‚ˆã†ã™ã‚’çµµã¨ã“ã¨ã°ã§è¨˜éŒ²ã€‚",level:2,minutes:8},
    {text:"ã¨ã‘ã‚‹ï¼Ÿã¨ã‘ãªã„ï¼Ÿï¼ˆç ‚ç³–ã¨æ°´ãªã©ï¼‰ã‚’ãŸã‚ã™ã€‚",level:1,minutes:7},
    {text:"è¦‹ã¤ã‘ãŸçŸ³ã‚„è‘‰ã‚’ã€Œå¤§ãã„ãƒ»å°ã•ã„ã€ã§åˆ†ã‘ã‚‹ã€‚",level:2,minutes:8},
    {text:"å¤œã®ç©ºã§æ˜Ÿã‚„æœˆã‚’1ã¤è¦³å¯Ÿã—ã€å½¢ã‚’ã‚¹ã‚±ãƒƒãƒã€‚",level:1,minutes:8},
    {text:"éŸ³ã¯ã©ã†ä¼ã‚ã‚‹ï¼Ÿèº«è¿‘ãªéŸ³ã‚’1ã¤èª¿ã¹ã¦æ›¸ãã€‚",level:3,minutes:9}
  ],
  "äººç‰©ã®ãƒã‚¿":[
    {text:"äººç‰©ã‚’1äººãˆã‚‰ã³ã€ã©ã‚“ãªæ™‚ä»£ã®äººã‹1è¡Œã§æ›¸ãã€‚",level:1,minutes:7},
    {text:"ãã®äººã®ä»•äº‹ã‚’1ã¤è¦‹ã¤ã‘ã¦ã€ãã‚ã—ã1è¡Œã€‚",level:1,minutes:7},
    {text:"å‡ºæ¥äº‹ã‚’2ã¤ãªã‚‰ã¹ã¦ãƒŸãƒ‹å¹´è¡¨ã«ã™ã‚‹ã€‚",level:2,minutes:8},
    {text:"åè¨€ã‚’1ã¤èª¿ã¹ã€æ„Ÿã˜ãŸã“ã¨ã‚’1è¡Œã§æ›¸ãã€‚",level:2,minutes:8},
    {text:"é–¢ã‚ã£ãŸå›½ã‚„å ´æ‰€ã‚’åœ°å›³ã§è¦‹ã¤ã‘ã¦ãƒ¡ãƒ¢ã™ã‚‹ã€‚",level:2,minutes:9},
    {text:"ãã®äººã«èã„ã¦ã¿ãŸã„è³ªå•ã‚’2ã¤è€ƒãˆã‚‹ã€‚",level:1,minutes:6},
    {text:"åŒã˜æ™‚ä»£ã®åˆ¥ã®äººç‰©ã‚’1äººè¦‹ã¤ã‘ã¦å…±é€šç‚¹ã‚’æ›¸ãã€‚",level:3,minutes:10},
    {text:"ãã®äººã®ä¼¼é¡”çµµã‚’ã‹ã‚“ãŸã‚“ã«ã‹ã„ã¦ã¿ã‚ˆã†ã€‚",level:1,minutes:8},
    {text:"ä»Šæ—¥ã‚ã‹ã£ãŸã“ã¨ã‚’3ã¤ã€ç®‡æ¡æ›¸ãã«ã™ã‚‹ã€‚",level:2,minutes:8},
    {text:"ãã®äººã®ã™ã”ã„ã¨ã“ã‚ã‚’1ã¤ã€ç†ç”±ã¤ãã§æ›¸ãã€‚",level:3,minutes:9}
  ],
  "è‹±èª":[
    {text:"ã‚ã„ã•ã¤ï¼ˆHello/Good morningï¼‰ã‚’å£°ã«å‡ºã™ã€‚",level:1,minutes:3},
    {text:"æ•°å­—1ã€œ10ã‚’è‹±èªã§è¨€ã£ã¦ã¿ã‚ˆã†ã€‚",level:1,minutes:4},
    {text:"èº«ã®å›ã‚Šã®ç‰©ã«è‹±èªãƒ©ãƒ™ãƒ«ã‚’2ã¤ä½œã£ã¦èª­ã‚‚ã†ã€‚",level:1,minutes:6},
    {text:"è‡ªåˆ†ã®ãªã¾ãˆã¨å¥½ããªã‚‚ã®ã‚’è‹±èªã§1æ–‡ãšã¤ã€‚",level:2,minutes:7},
    {text:"è‰²ã®è‹±å˜èªã‚’3ã¤æ›¸ã„ã¦ã€å£°ã«å‡ºã™ã€‚",level:1,minutes:5},
    {text:"è‹±å˜èªã‚’3ã¤ãˆã‚‰ã³ã€ã‹ã‚“ãŸã‚“è‹±æ–‡ã‚’å„1æ–‡ã€‚",level:2,minutes:8},
    {text:"çŸ­ã„è‹±èªæ–‡ã‚’éŸ³èª­ã—ã¦ã€å‹•è©ã‚’1ã¤è¦‹ã¤ã‘ã‚‹ã€‚",level:2,minutes:7},
    {text:"å®¶æ—ã‚’è‹±èªã§ç´¹ä»‹ã™ã‚‹æ–‡ã‚’2æ–‡ä½œã‚‹ã€‚",level:2,minutes:8},
    {text:"æ™‚åˆ»ã®è¨€ã„æ–¹ã‚’1ã¤ç·´ç¿’ï¼ˆItâ€™s seven oâ€™clock.ãªã©ï¼‰ã€‚",level:3,minutes:8},
    {text:"è‹±å˜èªã‚«ãƒ¼ãƒ‰ã‚’3æšä½œã£ã¦3å›ãšã¤èª­ã‚€ã€‚",level:2,minutes:8}
  ]
};
const MESSAGES=[
  "ã‚ãªãŸã®ãƒšãƒ¼ã‚¹ã§å¤§ä¸ˆå¤«ã€‚<ruby>ç„¦<rt>ã‚ã›</rt></ruby>ã‚‰ãªãã¦ã‚‚é€²ã‚“ã§ã„ã¾ã™",
  "å°ã•ãªä¸€æ­©ãŒã€å¤§ããªå¤‰åŒ–ã«ã¤ãªãŒã‚Šã¾ã™",
  "å‘¨ã‚Šã®äººãŒã€ã‚ãªãŸã‚’ã—ã£ã‹ã‚Šæ”¯ãˆã¦ã„ã¾ã™",
  "<ruby>ç¬‘é¡”<rt>ãˆãŒãŠ</rt></ruby>ã§<ruby>é<rt>ã™</rt></ruby>ã”ã›ã°ã€è‰¯ã„ã“ã¨ãŒè¿”ã£ã¦ãã¾ã™",
  "å¤±æ•—ã‚‚<ruby>çµŒé¨“<rt>ã‘ã„ã‘ã‚“</rt></ruby>ã®ä¸€ã¤ã€‚æ¬¡ã«ã¤ãªãŒã‚‹å¤§åˆ‡ãªæ™‚é–“ã§ã™",
  "æ°—æŒã¡ã‚’åˆ‡ã‚Š<ruby>æ›¿<rt>ã‹</rt></ruby>ãˆã‚Œã°ã€æ–°ã—ã„é“ãŒè¦‹ãˆã¦ãã¾ã™",
  "ã‚ãªãŸã®åŠªåŠ›ã¯ã€ã¡ã‚ƒã‚“ã¨<ruby>èª°<rt>ã ã‚Œ</rt></ruby>ã‹ã«å±Šã„ã¦ã„ã¾ã™",
  "ä»Šã¯ä¼‘ã‚€ã“ã¨ã‚‚å¤§åˆ‡ãª<ruby>é¸æŠ<rt>ã›ã‚“ãŸã</rt></ruby>ã§ã™",
  "æ˜æ—¥ã¯æ–°ã—ã„å‡ºä¼šã„ã«æµã¾ã‚Œã‚‹",
  "ç¬‘é¡”ãŒ<ruby>å¹¸é‹<rt>ã“ã†ã†ã‚“</rt></ruby>ã‚’å¼•ãå¯„ã›ã‚‹ä¸€æ—¥",
  "åŠªåŠ›ãŒå½¢ã«ãªã‚Šå¤¢ã¸è¿‘ã¥ã‘ã‚‹",
  "å°ã•ãªä¸€æ­©ãŒå¤§ããªæœªæ¥ã‚’é–‹ã",
  "<ruby>å„ª<rt>ã‚„ã•</rt></ruby>ã—ã„è¨€è‘‰ãŒ<ruby>å¹¸é‹<rt>ã“ã†ã†ã‚“</rt></ruby>ã‚’å‘¼ã³è¾¼ã‚€",
  "æ€ã„åˆ‡ã£ãŸ<ruby>æŒ‘æˆ¦<rt>ã¡ã‚‡ã†ã›ã‚“</rt></ruby>ã«å…‰ãŒ<ruby>å°„<rt>ã•</rt></ruby>ã™æ—¥",
 "å‘¨å›²ã®æ”¯ãˆã§é“ãŒ<ruby>æ‹“<rt>ã²ã‚‰</rt></ruby>ã‘ã¦ã„ã",
  "ã‚ãªãŸã®<ruby>é­…åŠ›<rt>ã¿ã‚Šã‚‡ã</rt></ruby>ãŒ<ruby>è¼<rt>ã‹ãŒã‚„</rt></ruby>ãã‚’å¢—ã™æ—¥",
  "ç´ ç›´ãªå¿ƒãŒ<ruby>å¥‡è·¡<rt>ãã›ã</rt></ruby>ã‚’å¼•ãå¯„ã›ã‚‹",
   "ä»Šæ—¥ã®è¡Œå‹•ãŒæœªæ¥ã‚’æ˜ã‚‹ãã™ã‚‹",
  "æ˜æ—¥ã¯ä»Šæ—¥ã‚ˆã‚Šã€ã‚‚ã£ã¨æ˜ã‚‹ã„ä¸€æ—¥ã«ãªã‚Šã¾ã™"
];
const RANKS=["ğŸ“šå¤§å‰","ğŸ“ä¸­å‰","ğŸ’¡å‰","ğŸ™‚å°å‰","ğŸŒ±æœ«å‰"];

/* ===== è¦ç´  ===== */
const canvas=document.getElementById("videoCanvas");
const ctx=canvas.getContext("2d",{willReadFrequently:true});
const video=document.getElementById("src");
const fortuneBox=document.getElementById("fortune");
const historyBox=document.getElementById("history");
const clearHistoryBtn=document.getElementById("clearHistory");
const stageWrap=document.getElementById("stageWrap");
const hoverHint=document.getElementById("hoverHint");

/* ===== ã‚·ãƒ³ãƒ—ãƒ«RGBã‚¯ãƒ­ãƒã‚­ãƒ¼ï¼ˆUIãªã—ï¼‰ =====
   æ¡ä»¶: g > 110 && r < 120 && b < 120 && g > r + 25 && g > b + 25 â†’ é€æ˜ */
function draw() {
  const vw = video.videoWidth || canvas.width;
  const vh = video.videoHeight || canvas.height;
  const scale = Math.min(canvas.width/vw, canvas.height/vh);
  const dw = Math.round(vw*scale), dh = Math.round(vh*scale);
  const dx = (canvas.width - dw) >> 1, dy = (canvas.height - dh) >> 1;

  ctx.clearRect(0,0,canvas.width,canvas.height);
  if (!video.paused && !video.ended) {
    ctx.drawImage(video, dx, dy, dw, dh);
    const img = ctx.getImageData(dx, dy, dw, dh);
    const d = img.data;
    for (let i=0;i<d.length;i+=4){
      const r=d[i], g=d[i+1], b=d[i+2];
      if (g > 110 && r < 120 && b < 120 && g > r + 25 && g > b + 25) {
        d[i+3] = 0; // é€æ˜
      }
    }
    ctx.putImageData(img, dx, dy);
  }
  rafId = requestAnimationFrame(draw);
}

/* ===== 0-1ç§’ãƒ«ãƒ¼ãƒ—ç›£è¦– ===== */
function loopWatch() {
  if (!spinning) return;
  if (video.currentTime >= LOOP_END || video.currentTime < LOOP_START) {
    video.currentTime = LOOP_START + 0.001;
  }
  requestAnimationFrame(loopWatch);
}

/* ===== å ã„ ===== */
const pick = arr => arr[Math.floor(Math.random()*arr.length)];
function buildFortuneHTML(){
  const rank=pick(RANKS);
  const subject=pick(SUBJECTS);
  const missions=SUBJECT_MISSIONS[subject] || [{text:"ä»Šæ—¥ã®ãƒ†ãƒ¼ãƒã§è‡ªç”±ç ”ç©¶ã‚’1ã¤ï¼",level:2,minutes:10}];
  const m=pick(missions);
  const points=Math.floor(Math.random()*8)+3; // 3..10
  const bar="â– ".repeat(points)+"â–¡".repeat(10-points);
  const subjectHTML=applyRuby(subject);
  const missionHTML=applyRuby(m.text);
  const message=pick(MESSAGES);
  return `
    <div class="line">ğŸ‰ ä»Šæ—¥ã®<ruby>å‹‰å¼·é‹<rt>ã¹ã‚“ãã‚‡ã†ã†ã‚“</rt></ruby> ğŸ‰</div>
    <div class="line"><ruby>é‹å‹¢<rt>ã†ã‚“ã›ã„</rt></ruby>ï¼š ${rank}</div>
    <div class="line">ã‚„ã‚‹æ°—ãƒ‘ãƒ¯ãƒ¼ï¼š <span class="mono">${bar}</span>ï¼ˆ${points}/10ï¼‰</div>
    <div class="line">ğŸ“– ãŠã™ã™ã‚æ•™ç§‘ï¼š ${subjectHTML}</div>

    <div class="line">ğŸ’¬ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼š ${message}</div>
  `;
}
function showFortune(){
  const html=buildFortuneHTML();
  fortuneBox.innerHTML=html;
  const div=document.createElement("div");
  div.className="history-item";
  div.innerHTML=`<div class="muted">${new Date().toLocaleString()}</div>${html}`;
  historyBox.prepend(div);
  addHistory({time:new Date().toLocaleString(), html});
}

/* ===== å±¥æ­´ï¼ˆlocalStorageï¼‰ ===== */
const LS_KEY="fortuneHistorySimple";
const loadHistory=()=>{try{return JSON.parse(localStorage.getItem(LS_KEY)||"[]");}catch(e){return[];}};
const saveHistory=list=>localStorage.setItem(LS_KEY,JSON.stringify(list));
function renderHistory(){
  const list=loadHistory();
  historyBox.innerHTML="";
  for(const it of list){
    const div=document.createElement("div");
    div.className="history-item";
    div.innerHTML=`<div class="muted">${it.time}</div>${it.html}`;
    historyBox.appendChild(div);
  }
}
function addHistory(entry){
  const list=loadHistory();
  list.unshift(entry);
  if(list.length>300) list.pop();
  saveHistory(list);
}
clearHistoryBtn.addEventListener("click", ()=>{
  if(confirm("å±¥æ­´ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")){
    saveHistory([]); renderHistory();
  }
});

/* ===== å…¥åŠ› ===== */
function pressStart(){
  if (playing) return;
  spinning = true;
  shouldShowFortune=false;
  fortuneBox.textContent = "ï¼ˆé•·æŠ¼ã—ä¸­â€¦ é›¢ã™ã¨,å ã„ãŒå‡ºã¾ã™ï¼‰";
  video.currentTime = LOOP_START;
  video.play().catch(()=>{});
  if (!rafId) draw();
  loopWatch();
}
function pressEnd(){
  if (playing) return;
  spinning = false;
  playing = true;
  shouldShowFortune=true;
  video.currentTime = LOOP_END;
  video.play().catch(()=>{});
}

/* ===== å†ç”Ÿçµ‚äº†æ™‚ã«å ã„ ===== */
video.addEventListener('ended', () => {
  if (shouldShowFortune) { showFortune(); shouldShowFortune=false; }
  playing = false;
  cancelAnimationFrame(rafId); rafId = null;
});

/* ===== ãƒ›ãƒãƒ¼æ¡ˆå†…ï¼ˆPCï¼‰ï¼ã‚¿ãƒƒãƒã§éè¡¨ç¤º ===== */
stageWrap.addEventListener('mouseenter', ()=> hoverHint.style.display='block');
stageWrap.addEventListener('mouseleave', ()=> hoverHint.style.display='none');
canvas.addEventListener('touchstart', ()=> hoverHint.style.display='none', {passive:true});

/* ===== ã‚¤ãƒ™ãƒ³ãƒˆç™»éŒ² ===== */
canvas.addEventListener('mousedown', e => { e.preventDefault(); pressStart(); });
window.addEventListener('mouseup',   e => { e.preventDefault(); pressEnd(); });
canvas.addEventListener('touchstart', e => { e.preventDefault(); pressStart(); }, {passive:false});
window.addEventListener('touchend',   e => { e.preventDefault(); pressEnd(); },   {passive:false});

/* ===== åˆæœŸæç”»é–‹å§‹ ===== */
video.addEventListener('loadeddata', () => { if (!rafId) draw(); });
setTimeout(()=>{ if (!rafId) draw(); }, 1500); // ç«¯æœ«å·®å¯¾ç­–
renderHistory();
</script>
</body>
</html>


