<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ã‚¬ãƒ©ã‚¬ãƒ©çƒå ã„</title>
<style>
  body{font-family:system-ui,-apple-system,"Segoe UI",Meiryo,Arial,sans-serif;text-align:center;background:#fafafa;margin:0;padding:24px}
  #videoCanvas{background:transparent;cursor:pointer;border-radius:12px;box-shadow:0 4px 18px rgba(0,0,0,.08)}
  #fortune{white-space:pre-line;margin:14px auto;max-width:520px;text-align:left;background:#fff;border:1px dashed #ccd;padding:12px;border-radius:10px}
  #clearHistory{margin-top:10px;padding:6px 12px;border:none;background:#d9534f;color:#fff;border-radius:6px;cursor:pointer}
  #clearHistory:hover{background:#c9302c}
  .history-item{border-top:1px solid #e8e8e8;padding:8px 0;text-align:left;max-width:520px;margin:0 auto}
  p.note{color:#666;margin:8px 0 16px}
</style>
</head>
<body>

<h1>ã‚¬ãƒ©ã‚¬ãƒ©çƒå ã„</h1>

<canvas id="videoCanvas" width="300" height="300" title="ã“ã“ã‚’é•·æŠ¼ã—ï¼"></canvas>
<div id="fortune">ï¼ˆã“ã“ã«å ã„çµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™ï¼‰</div>

<!-- å±¥æ­´ã¨å‰Šé™¤ãƒœã‚¿ãƒ³ -->
<button id="clearHistory">å±¥æ­´ã‚’å‰Šé™¤</button>
<div id="history"></div>

<!-- éè¡¨ç¤ºã®å‹•ç”»ã®ã¿ï¼ˆéŸ³å£°ã¯å‰Šé™¤ï¼‰ -->
<video id="src" src="garagara.mp4" playsinline preload="auto" style="display:none"></video>

<script>
/* ===== å ã„ãƒ‡ãƒ¼ã‚¿ ===== */
const SUBJECTS = ["èª­æ›¸","ç®—æ•°","æ¼¢å­—","ç†ç§‘","äººç‰©ã®ãƒã‚¿","è‹±èª"];
const MISSIONS = ["æœ¬ã‚’5åˆ†èª­ã‚€","ç®—æ•°ãƒ‰ãƒªãƒ«3å•","æ¼¢å­—1ã¤èª¿ã¹ã‚‹","æ¤ç‰©ã‚„è™«ã‚’1ç¨®é¡èª¿ã¹ã‚‹","æ­´å²ä¸Šã®äººç‰©1äººèª¿ã¹ã‚‹","è‹±å˜èª3ã¤è¦šãˆã‚‹"];
const MESSAGES = ["çŸ­æ™‚é–“ã§ã‚‚é›†ä¸­ã™ã‚Œã°é€²ã‚€ã‚ˆï¼","ä»Šæ—¥ã‚ã‹ã‚‰ãªã‹ã£ãŸã“ã¨ã¯æœªæ¥ã®å®ç‰©ã«ãªã‚‹ã‚ˆã€‚","è‹¦æ‰‹ãªåˆ†é‡ã‚‚1æ—¥1ã¤ãªã‚‰æ¥½å‹ï¼"];
const FORTUNE_RANKS = ["ğŸ“šå¤§å‰","ğŸ“ä¸­å‰","ğŸ’¡å‰","ğŸ™‚å°å‰","ğŸŒ±æœ«å‰"];

const canvas = document.getElementById("videoCanvas");
const ctx = canvas.getContext("2d", {willReadFrequently:true});
const video = document.getElementById("src");
const fortuneBox = document.getElementById("fortune");
const historyBox = document.getElementById("history");
const clearHistoryBtn = document.getElementById("clearHistory");

const LOOP_START = 0.0;
const LOOP_END   = 1.0;

let spinning = false;   // 0-1ç§’ãƒ«ãƒ¼ãƒ—ä¸­ï¼Ÿ
let playing  = false;   // é€šå¸¸å†ç”Ÿä¸­ï¼Ÿ
let rafId;

/* ===== æç”»ï¼‹ç°¡æ˜“ã‚¯ãƒ­ãƒã‚­ãƒ¼ï¼ˆç·‘â†’é€æ˜ï¼‰ ===== */
function draw() {
  const vw = video.videoWidth || canvas.width;
  const vh = video.videoHeight || canvas.height;
  const scale = Math.min(canvas.width/vw, canvas.height/vh);
  const dw = Math.round(vw*scale), dh = Math.round(vh*scale);
  const dx = (canvas.width - dw) >> 1, dy = (canvas.height - dh) >> 1;

  ctx.clearRect(0,0,canvas.width,canvas.height);
  if (!video.paused && !video.ended) {
    ctx.drawImage(video, dx, dy, dw, dh);

    // ç°¡æ˜“çš„ãªã‚­ãƒ¼ã‚¤ãƒ³ã‚°ï¼ˆæ˜ã‚‹ã„ç·‘ã‚’ä¸»ã«é™¤å»ï¼‰
    const img = ctx.getImageData(dx, dy, dw, dh);
    const d = img.data;
    for (let i=0;i<d.length;i+=4){
      const r=d[i], g=d[i+1], b=d[i+2];
      // å¿…è¦ã«å¿œã˜ã¦é–¾å€¤ã¯èª¿æ•´ã—ã¦ãã ã•ã„
      if (g > 110 && r < 120 && b < 120 && g > r + 25 && g > b + 25) {
        d[i+3] = 0; // é€æ˜åŒ–
      }
    }
    ctx.putImageData(img, dx, dy);
  }
  rafId = requestAnimationFrame(draw);
}

/* ===== 0-1ç§’ãƒ«ãƒ¼ãƒ—ç›£è¦– ===== */
function loopWatch() {
  if (!spinning) return;
  if (video.currentTime >= LOOP_END || video.currentTime < LOOP_START) {
    video.currentTime = LOOP_START + 0.001;
  }
  requestAnimationFrame(loopWatch);
}

/* ===== å ã„ ===== */
const pick = arr => arr[Math.floor(Math.random()*arr.length)];
function doFortune() {
  const rank = pick(FORTUNE_RANKS);
  const subject = pick(SUBJECTS);
  const mission = pick(MISSIONS);
  const message = pick(MESSAGES);
  const points = Math.floor(Math.random()*8)+3;
  const bar = "â– ".repeat(points) + "â–¡".repeat(10-points);
  const text =
    "ğŸ‰ ä»Šæ—¥ã®ã¹ã‚“ãã‚‡ã†ã†ã‚“ ğŸ‰\n\n" +
    `é‹å‹¢ï¼š ${rank}\n` +
    `ã‚„ã‚‹æ°—ãƒ‘ãƒ¯ãƒ¼ï¼š ${bar}ï¼ˆ${points}/10ï¼‰\n\n` +
    `ğŸ“– ãŠã™ã™ã‚æ•™ç§‘ï¼š ${subject}\n` +
    `ğŸ¯ ä»Šæ—¥ã®ãƒŸãƒƒã‚·ãƒ§ãƒ³ï¼š ${mission}\n\n` +
    `ğŸ’¬ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼š ${message}`;
  return {text};
}
function showFortune() {
  const f = doFortune();
  fortuneBox.textContent = f.text;
  const div = document.createElement("div");
  div.className = "history-item";
  div.textContent = `${new Date().toLocaleString()}\n${f.text}`;
  historyBox.prepend(div);
}

/* ===== å…¥åŠ›ï¼ˆPC/ã‚¹ãƒãƒ›ï¼‰ ===== */
function pressStart(){
  if (playing) return;       // é€šå¸¸å†ç”Ÿä¸­ã¯ç„¡è¦–
  spinning = true;
  fortuneBox.textContent = "ï¼ˆé•·æŠ¼ã—ä¸­â€¦ é›¢ã™ã¨,å ã„ãŒå‡ºã¾ã™ï¼‰";
  video.currentTime = LOOP_START;
  video.play().catch(()=>{});
  if (!rafId) draw();
  loopWatch();
}
function pressEnd(){
  if (playing) return;
  spinning = false;
  playing = true;
  // ç¶šãã‹ã‚‰æœ€å¾Œã¾ã§å†ç”Ÿ
  video.currentTime = LOOP_END;
  video.play().catch(()=>{});
}

/* ===== å†ç”Ÿçµ‚äº†æ™‚ã«å ã„ ===== */
video.addEventListener('ended', () => {
  if (!playing) return;   // é€šå¸¸å†ç”ŸãŒçµ‚ã‚ã£ãŸã¨ãã ã‘
  playing = false;
  cancelAnimationFrame(rafId); rafId = null; // æç”»ãƒ«ãƒ¼ãƒ—æ•´ç†ï¼ˆä»»æ„ï¼‰
  showFortune();
});

/* ===== å±¥æ­´å‰Šé™¤ ===== */
clearHistoryBtn.addEventListener("click", () => {
  if (confirm("å±¥æ­´ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
    historyBox.innerHTML = "";
  }
});

/* ===== ã‚¤ãƒ™ãƒ³ãƒˆç™»éŒ² ===== */
canvas.addEventListener('mousedown', e => { e.preventDefault(); pressStart(); });
window.addEventListener('mouseup',   e => { e.preventDefault(); pressEnd(); });
canvas.addEventListener('touchstart', e => { e.preventDefault(); pressStart(); }, {passive:false});
window.addEventListener('touchend',   e => { e.preventDefault(); pressEnd(); },   {passive:false});

/* ===== åˆæœŸæç”»é–‹å§‹ ===== */
video.addEventListener('loadeddata', () => { if (!rafId) draw(); });
setTimeout(()=>{ if (!rafId) draw(); }, 1500);
</script>
</body>
</html>


