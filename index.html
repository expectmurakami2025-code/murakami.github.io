<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title><ruby>自主勉<rt>じしゅべん</rt></ruby>うらない</title>
<style>
  body{font-family:system-ui,-apple-system,"Segoe UI",Meiryo,Arial,sans-serif;text-align:center;background:#fafafa;margin:0;padding:24px}
  h1{margin:0 0 6px}
  .muted{color:#666}
  .stage-wrap{position:relative;display:inline-block}
  #videoCanvas{background:transparent;cursor:pointer;border-radius:12px;box-shadow:0 4px 18px rgba(0,0,0,.08)}
  .checker{position:absolute;inset:0;background:conic-gradient(#eee 0 25%,#ddd 0 50%,#eee 0 75%,#ddd 0 100%);background-size:24px 24px;opacity:.45;pointer-events:none;border-radius:12px}
  #hoverHint{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);padding:8px 12px;background:rgba(255,255,255,.92);border:1px solid #dfe3f0;border-radius:10px;font-size:14px;color:#333;display:none;pointer-events:none;white-space:nowrap}
  ruby rt{font-size:.7em;color:#444}

  #fortune{white-space:normal;margin:14px auto;max-width:520px;text-align:left;background:#fff;border:1px dashed #ccd;padding:12px;border-radius:10px;line-height:1.7}
  #fortune .line{margin:.25em 0}
  #fortune .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
</style>
</head>
<body>


<h1><ruby>自主勉<rt>じしゅべん</rt></ruby>うらない</h1>
<p>↓を<ruby>長押<rt>ながお</rt></ruby>しして、はなすと「おみくじ」の玉が出ます。</p>
<div class="stage-wrap" id="stageWrap" title="ここをながおしして、はなすと「おみくじ」の玉が出ます。">
  <canvas id="videoCanvas" width="300" height="300" ></canvas>
  <div class="checker"></div>
</div>

<div id="fortune">（ここに占い結果が表示されます）</div>

<!-- 非表示の動画（音声なし） -->
<video id="src" src="garagara.mp4" playsinline preload="auto" muted style="display:none"></video>

<script>
/* ===== 設定・状態 ===== */
const LOOP_START = 0.0;   // 押下中：ここから
const LOOP_END   = 1.0;   // 押下中：ここまでをループ（離したらここから本再生）
const LOOP_EPS   = 1/30;  // だいたい1フレーム分（境界でのチラつき回避）
let holding=false, playingTail=false, shouldShowFortune=false;
let rafId=null, loopRafId=null;

/* ===== ふりがな辞書 ===== */
const RUBIES = [
  ["読書","どくしょ"],["算数","さんすう"],["漢字","かんじ"],["理科","りか"],["人物","じんぶつ"],["英語","えいご"]
];
const rubyMap=new Map(RUBIES);
function applyRuby(str){
  let out=str;
  const keys=[...rubyMap.keys()].sort((a,b)=>b.length-a.length);
  for(const k of keys){
    const rt=rubyMap.get(k);
    out=out.replace(new RegExp(k,"g"), `<ruby><rb>${k}</rb><rt>${rt}</rt></ruby>`);
  }
  return out;
}

/* ===== 占いデータ ===== */
const SUBJECTS=["読書","算数","漢字","理科","人物のネタ","英語"];
const MESSAGES=[
"あなたのペースで大丈夫。<ruby>焦<rt>あせ</rt></ruby>らなくても進んでいます",
  "小さな一歩が、大きな変化につながります",
  "周りの人が、あなたをしっかり支えています",
  "<ruby>笑顔<rt>えがお</rt></ruby>で<ruby>過<rt>す</rt></ruby>ごせば、良いことが返ってきます",
  "失敗も<ruby>経験<rt>けいけん</rt></ruby>の一つ。次につながる大切な時間です",
  "気持ちを切り<ruby>替<rt>か</rt></ruby>えれば、新しい道が見えてきます",
  "あなたの努力は、ちゃんと<ruby>誰<rt>だれ</rt></ruby>かに届いています",
  "今は休むことも大切な<ruby>選択<rt>せんたく</rt></ruby>です",
  "明日は新しい出会いに恵まれる",
  "笑顔が<ruby>幸運<rt>こううん</rt></ruby>を引き寄せる一日",
  "努力が形になり夢へ近づける",
  "小さな一歩が大きな未来を開く",
  "<ruby>優<rt>やさ</rt></ruby>しい言葉が<ruby>幸運<rt>こううん</rt></ruby>を呼び込む",
  "思い切った<ruby>挑戦<rt>ちょうせん</rt></ruby>に光が<ruby>射<rt>さ</rt></ruby>す日",
  "周囲の支えで道が<ruby>拓<rt>ひら</rt></ruby>けていく",
  "あなたの<ruby>魅力<rt>みりょく</rt></ruby>が<ruby>輝<rt>かがや</rt></ruby>きを増す日",
  "素直な心が<ruby>奇跡<rt>きせき</rt></ruby>を引き寄せる",
  "今日の行動が未来を明るくする",
  "明日は今日より、もっと明るい一日になります"
];
const RANKS=["📚大吉","📝中吉","💡吉","🙂小吉","🌱末吉"];

/* ===== 要素 ===== */
const canvas=document.getElementById("videoCanvas");
const ctx=canvas.getContext("2d",{willReadFrequently:true});
const video=document.getElementById("src");
const fortuneBox=document.getElementById("fortune");
const stageWrap=document.getElementById("stageWrap");
const hoverHint=document.getElementById("hoverHint");

/* ===== クロマキー処理付き描画 =====
   条件: g > 110 && r < 120 && b < 120 && g > r + 25 && g > b + 25 → 透明 */
function draw() {
  const vw = video.videoWidth || canvas.width;
  const vh = video.videoHeight || canvas.height;
  const scale = Math.min(canvas.width/vw, canvas.height/vh);
  const dw = Math.round(vw*scale), dh = Math.round(vh*scale);
  const dx = (canvas.width - dw) >> 1, dy = (canvas.height - dh) >> 1;

  ctx.clearRect(0,0,canvas.width,canvas.height);
  if (!video.paused && !video.ended) {
    ctx.drawImage(video, dx, dy, dw, dh);
    const img = ctx.getImageData(dx, dy, dw, dh);
    const d = img.data;
    for (let i=0;i<d.length;i+=4){
      const r=d[i], g=d[i+1], b=d[i+2];
      if (g > 110 && r < 120 && b < 120 && g > r + 25 && g > b + 25) {
        d[i+3] = 0; // 緑を透明化
      }
    }
    ctx.putImageData(img, dx, dy);
  }
  rafId = requestAnimationFrame(draw);
}

/* ===== 占い ===== */
const pick = arr => arr[Math.floor(Math.random()*arr.length)];
function buildFortuneHTML(){
  const rank=pick(RANKS);
  const subject=pick(SUBJECTS);
  const message=pick(MESSAGES);
  return `
    <div class="line">🎉 今日の勉強運 🎉</div>
    <div class="line">運勢： ${rank}</div>
    <div class="line">📖 おすすめ教科： ${applyRuby(subject)}</div>
    <div class="line">💬 メッセージ： ${message}</div>
  `;
}
function showFortune(){
  fortuneBox.innerHTML=buildFortuneHTML();
}

/* ===== ループ監視（押下中 0.0〜1.0s を往復ではなく区間ループ） ===== */
function startLoopGuard(){
  if (loopRafId) return;
  const loopTick = () => {
    if (!holding) { loopRafId = null; return; }
    // ループ上端を越えたら巻き戻す
    if (video.currentTime >= (LOOP_END - LOOP_EPS)) {
      // わずかに余裕を持たせて巻き戻し（境界での停止を回避）
      const target = LOOP_START + 0.002;
      if (!video.seeking) video.currentTime = target;
    }
    // なんらかで止まっていたら再開
    if (video.paused) { video.play().catch(()=>{}); }
    loopRafId = requestAnimationFrame(loopTick);
  };
  loopRafId = requestAnimationFrame(loopTick);
}

/* ===== 入力 ===== */
function pressStart(){
  if (playingTail) return;           // 尾部再生中は無視
  holding = true;
  shouldShowFortune=false;
  fortuneBox.textContent = "（長押し中… 離すと占いが出ます）";

  // 押下で 0.0s から再生開始し、監視で 0.0〜1.0s をループ
  // 先に currentTime を合わせてから play（モバイル互換）
  try { video.currentTime = LOOP_START; } catch(_){}
  video.play().catch(()=>{});
  startLoopGuard();
  if (!rafId) draw();
}

function pressEnd(){
  if (!holding) return;
  holding = false;
  playingTail = true;
  shouldShowFortune=true;

  // ループ終了：1.0s 位置に送り、そこから最後まで本再生
  try {
    if (video.currentTime < LOOP_END - LOOP_EPS || video.currentTime > LOOP_END + 0.2) {
      video.currentTime = LOOP_END;
    }
  } catch(_){}
  video.play().catch(()=>{});
}

video.addEventListener('ended', () => {
  if (shouldShowFortune) { showFortune(); shouldShowFortune=false; }
  playingTail = false;

  // 次の操作に備えて描画ループは維持、動画は停止状態
});

/* ===== ホバー案内 ===== */
stageWrap.addEventListener('mouseenter', ()=> hoverHint && (hoverHint.style.display='block'));
stageWrap.addEventListener('mouseleave', ()=> hoverHint && (hoverHint.style.display='none'));
canvas.addEventListener('touchstart', ()=> hoverHint && (hoverHint.style.display='none'), {passive:true});

/* ===== イベント登録 ===== */
canvas.addEventListener('mousedown', e => { e.preventDefault(); pressStart(); });
window.addEventListener('mouseup',   e => { e.preventDefault(); pressEnd(); });
canvas.addEventListener('touchstart', e => { e.preventDefault(); pressStart(); }, {passive:false});
window.addEventListener('touchend',   e => { e.preventDefault(); pressEnd(); },   {passive:false});

/* ===== 初期描画開始 ===== */
video.addEventListener('loadeddata', () => {
  // iOSなどでのスタート安定化
  video.muted = true;
  if (!rafId) draw();
});
setTimeout(()=>{ if (!rafId) draw(); }, 1200);
</script>
</body>
</html>


