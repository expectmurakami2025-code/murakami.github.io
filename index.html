<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title><ruby>è‡ªä¸»å‹‰<rt>ã˜ã—ã‚…ã¹ã‚“</rt></ruby>ã†ã‚‰ãªã„</title>
<style>
  body{font-family:system-ui,-apple-system,"Segoe UI",Meiryo,Arial,sans-serif;text-align:center;background:#fafafa;margin:0;padding:24px}
  h1{margin:0 0 6px}
  .muted{color:#666}
  .stage-wrap{position:relative;display:inline-block}
  #videoCanvas{background:transparent;cursor:pointer;border-radius:12px;box-shadow:0 4px 18px rgba(0,0,0,.08)}
  .checker{position:absolute;inset:0;background:conic-gradient(#eee 0 25%,#ddd 0 50%,#eee 0 75%,#ddd 0 100%);background-size:24px 24px;opacity:.45;pointer-events:none;border-radius:12px}
  #hoverHint{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);padding:8px 12px;background:rgba(255,255,255,.92);border:1px solid #dfe3f0;border-radius:10px;font-size:14px;color:#333;display:none;pointer-events:none;white-space:nowrap}
  ruby rt{font-size:.7em;color:#444}

  #fortune{white-space:normal;margin:14px auto;max-width:520px;text-align:left;background:#fff;border:1px dashed #ccd;padding:12px;border-radius:10px;line-height:1.7}
  #fortune .line{margin:.25em 0}
  #fortune .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
</style>
</head>
<body>


<h1><ruby>è‡ªä¸»å‹‰<rt>ã˜ã—ã‚…ã¹ã‚“</rt></ruby>ã†ã‚‰ãªã„</h1>
<p>â†“ã‚’<ruby>é•·æŠ¼<rt>ãªãŒãŠ</rt></ruby>ã—ã—ã¦ã€ã¯ãªã™ã¨ã€ŒãŠã¿ãã˜ã€ã®ç‰ãŒå‡ºã¾ã™ã€‚</p>
<div class="stage-wrap" id="stageWrap" title="ã“ã“ã‚’ãªãŒãŠã—ã—ã¦ã€ã¯ãªã™ã¨ã€ŒãŠã¿ãã˜ã€ã®ç‰ãŒå‡ºã¾ã™ã€‚">
  <canvas id="videoCanvas" width="300" height="300" ></canvas>
  <div class="checker"></div>
</div>

<div id="fortune">ï¼ˆã“ã“ã«å ã„çµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™ï¼‰</div>

<!-- éè¡¨ç¤ºã®å‹•ç”»ï¼ˆéŸ³å£°ãªã—ï¼‰ -->
<video id="src" src="garagara.mp4" playsinline preload="auto" muted style="display:none"></video>

<script>
/* ===== è¨­å®šãƒ»çŠ¶æ…‹ ===== */
const LOOP_START = 0.0;   // æŠ¼ä¸‹ä¸­ï¼šã“ã“ã‹ã‚‰
const LOOP_END   = 1.0;   // æŠ¼ä¸‹ä¸­ï¼šã“ã“ã¾ã§ã‚’ãƒ«ãƒ¼ãƒ—ï¼ˆé›¢ã—ãŸã‚‰ã“ã“ã‹ã‚‰æœ¬å†ç”Ÿï¼‰
const LOOP_EPS   = 1/30;  // ã ã„ãŸã„1ãƒ•ãƒ¬ãƒ¼ãƒ åˆ†ï¼ˆå¢ƒç•Œã§ã®ãƒãƒ©ã¤ãå›é¿ï¼‰
let holding=false, playingTail=false, shouldShowFortune=false;
let rafId=null, loopRafId=null;

/* ===== ãµã‚ŠãŒãªè¾æ›¸ ===== */
const RUBIES = [
  ["èª­æ›¸","ã©ãã—ã‚‡"],["ç®—æ•°","ã•ã‚“ã™ã†"],["æ¼¢å­—","ã‹ã‚“ã˜"],["ç†ç§‘","ã‚Šã‹"],["äººç‰©","ã˜ã‚“ã¶ã¤"],["è‹±èª","ãˆã„ã”"]
];
const rubyMap=new Map(RUBIES);
function applyRuby(str){
  let out=str;
  const keys=[...rubyMap.keys()].sort((a,b)=>b.length-a.length);
  for(const k of keys){
    const rt=rubyMap.get(k);
    out=out.replace(new RegExp(k,"g"), `<ruby><rb>${k}</rb><rt>${rt}</rt></ruby>`);
  }
  return out;
}

/* ===== å ã„ãƒ‡ãƒ¼ã‚¿ ===== */
const SUBJECTS=["èª­æ›¸","ç®—æ•°","æ¼¢å­—","ç†ç§‘","äººç‰©ã®ãƒã‚¿","è‹±èª"];
const MESSAGES=[
"ã‚ãªãŸã®ãƒšãƒ¼ã‚¹ã§å¤§ä¸ˆå¤«ã€‚<ruby>ç„¦<rt>ã‚ã›</rt></ruby>ã‚‰ãªãã¦ã‚‚é€²ã‚“ã§ã„ã¾ã™",
  "å°ã•ãªä¸€æ­©ãŒã€å¤§ããªå¤‰åŒ–ã«ã¤ãªãŒã‚Šã¾ã™",
  "å‘¨ã‚Šã®äººãŒã€ã‚ãªãŸã‚’ã—ã£ã‹ã‚Šæ”¯ãˆã¦ã„ã¾ã™",
  "<ruby>ç¬‘é¡”<rt>ãˆãŒãŠ</rt></ruby>ã§<ruby>é<rt>ã™</rt></ruby>ã”ã›ã°ã€è‰¯ã„ã“ã¨ãŒè¿”ã£ã¦ãã¾ã™",
  "å¤±æ•—ã‚‚<ruby>çµŒé¨“<rt>ã‘ã„ã‘ã‚“</rt></ruby>ã®ä¸€ã¤ã€‚æ¬¡ã«ã¤ãªãŒã‚‹å¤§åˆ‡ãªæ™‚é–“ã§ã™",
  "æ°—æŒã¡ã‚’åˆ‡ã‚Š<ruby>æ›¿<rt>ã‹</rt></ruby>ãˆã‚Œã°ã€æ–°ã—ã„é“ãŒè¦‹ãˆã¦ãã¾ã™",
  "ã‚ãªãŸã®åŠªåŠ›ã¯ã€ã¡ã‚ƒã‚“ã¨<ruby>èª°<rt>ã ã‚Œ</rt></ruby>ã‹ã«å±Šã„ã¦ã„ã¾ã™",
  "ä»Šã¯ä¼‘ã‚€ã“ã¨ã‚‚å¤§åˆ‡ãª<ruby>é¸æŠ<rt>ã›ã‚“ãŸã</rt></ruby>ã§ã™",
  "æ˜æ—¥ã¯æ–°ã—ã„å‡ºä¼šã„ã«æµã¾ã‚Œã‚‹",
  "ç¬‘é¡”ãŒ<ruby>å¹¸é‹<rt>ã“ã†ã†ã‚“</rt></ruby>ã‚’å¼•ãå¯„ã›ã‚‹ä¸€æ—¥",
  "åŠªåŠ›ãŒå½¢ã«ãªã‚Šå¤¢ã¸è¿‘ã¥ã‘ã‚‹",
  "å°ã•ãªä¸€æ­©ãŒå¤§ããªæœªæ¥ã‚’é–‹ã",
  "<ruby>å„ª<rt>ã‚„ã•</rt></ruby>ã—ã„è¨€è‘‰ãŒ<ruby>å¹¸é‹<rt>ã“ã†ã†ã‚“</rt></ruby>ã‚’å‘¼ã³è¾¼ã‚€",
  "æ€ã„åˆ‡ã£ãŸ<ruby>æŒ‘æˆ¦<rt>ã¡ã‚‡ã†ã›ã‚“</rt></ruby>ã«å…‰ãŒ<ruby>å°„<rt>ã•</rt></ruby>ã™æ—¥",
  "å‘¨å›²ã®æ”¯ãˆã§é“ãŒ<ruby>æ‹“<rt>ã²ã‚‰</rt></ruby>ã‘ã¦ã„ã",
  "ã‚ãªãŸã®<ruby>é­…åŠ›<rt>ã¿ã‚Šã‚‡ã</rt></ruby>ãŒ<ruby>è¼<rt>ã‹ãŒã‚„</rt></ruby>ãã‚’å¢—ã™æ—¥",
  "ç´ ç›´ãªå¿ƒãŒ<ruby>å¥‡è·¡<rt>ãã›ã</rt></ruby>ã‚’å¼•ãå¯„ã›ã‚‹",
  "ä»Šæ—¥ã®è¡Œå‹•ãŒæœªæ¥ã‚’æ˜ã‚‹ãã™ã‚‹",
  "æ˜æ—¥ã¯ä»Šæ—¥ã‚ˆã‚Šã€ã‚‚ã£ã¨æ˜ã‚‹ã„ä¸€æ—¥ã«ãªã‚Šã¾ã™"
];
const RANKS=["ğŸ“šå¤§å‰","ğŸ“ä¸­å‰","ğŸ’¡å‰","ğŸ™‚å°å‰","ğŸŒ±æœ«å‰"];

/* ===== è¦ç´  ===== */
const canvas=document.getElementById("videoCanvas");
const ctx=canvas.getContext("2d",{willReadFrequently:true});
const video=document.getElementById("src");
const fortuneBox=document.getElementById("fortune");
const stageWrap=document.getElementById("stageWrap");
const hoverHint=document.getElementById("hoverHint");

/* ===== ã‚¯ãƒ­ãƒã‚­ãƒ¼å‡¦ç†ä»˜ãæç”» =====
   æ¡ä»¶: g > 110 && r < 120 && b < 120 && g > r + 25 && g > b + 25 â†’ é€æ˜ */
function draw() {
  const vw = video.videoWidth || canvas.width;
  const vh = video.videoHeight || canvas.height;
  const scale = Math.min(canvas.width/vw, canvas.height/vh);
  const dw = Math.round(vw*scale), dh = Math.round(vh*scale);
  const dx = (canvas.width - dw) >> 1, dy = (canvas.height - dh) >> 1;

  ctx.clearRect(0,0,canvas.width,canvas.height);
  if (!video.paused && !video.ended) {
    ctx.drawImage(video, dx, dy, dw, dh);
    const img = ctx.getImageData(dx, dy, dw, dh);
    const d = img.data;
    for (let i=0;i<d.length;i+=4){
      const r=d[i], g=d[i+1], b=d[i+2];
      if (g > 110 && r < 120 && b < 120 && g > r + 25 && g > b + 25) {
        d[i+3] = 0; // ç·‘ã‚’é€æ˜åŒ–
      }
    }
    ctx.putImageData(img, dx, dy);
  }
  rafId = requestAnimationFrame(draw);
}

/* ===== å ã„ ===== */
const pick = arr => arr[Math.floor(Math.random()*arr.length)];
function buildFortuneHTML(){
  const rank=pick(RANKS);
  const subject=pick(SUBJECTS);
  const message=pick(MESSAGES);
  return `
    <div class="line">ğŸ‰ ä»Šæ—¥ã®å‹‰å¼·é‹ ğŸ‰</div>
    <div class="line">é‹å‹¢ï¼š ${rank}</div>
    <div class="line">ğŸ“– ãŠã™ã™ã‚æ•™ç§‘ï¼š ${applyRuby(subject)}</div>
    <div class="line">ğŸ’¬ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼š ${message}</div>
  `;
}
function showFortune(){
  fortuneBox.innerHTML=buildFortuneHTML();
}

/* ===== ãƒ«ãƒ¼ãƒ—ç›£è¦–ï¼ˆæŠ¼ä¸‹ä¸­ 0.0ã€œ1.0s ã‚’å¾€å¾©ã§ã¯ãªãåŒºé–“ãƒ«ãƒ¼ãƒ—ï¼‰ ===== */
function startLoopGuard(){
  if (loopRafId) return;
  const loopTick = () => {
    if (!holding) { loopRafId = null; return; }
    // ãƒ«ãƒ¼ãƒ—ä¸Šç«¯ã‚’è¶ŠãˆãŸã‚‰å·»ãæˆ»ã™
    if (video.currentTime >= (LOOP_END - LOOP_EPS)) {
      // ã‚ãšã‹ã«ä½™è£•ã‚’æŒãŸã›ã¦å·»ãæˆ»ã—ï¼ˆå¢ƒç•Œã§ã®åœæ­¢ã‚’å›é¿ï¼‰
      const target = LOOP_START + 0.002;
      if (!video.seeking) video.currentTime = target;
    }
    // ãªã‚“ã‚‰ã‹ã§æ­¢ã¾ã£ã¦ã„ãŸã‚‰å†é–‹
    if (video.paused) { video.play().catch(()=>{}); }
    loopRafId = requestAnimationFrame(loopTick);
  };
  loopRafId = requestAnimationFrame(loopTick);
}

/* ===== å…¥åŠ› ===== */
function pressStart(){
  if (playingTail) return;           // å°¾éƒ¨å†ç”Ÿä¸­ã¯ç„¡è¦–
  holding = true;
  shouldShowFortune=false;
  fortuneBox.textContent = "ï¼ˆé•·æŠ¼ã—ä¸­â€¦ é›¢ã™ã¨å ã„ãŒå‡ºã¾ã™ï¼‰";

  // æŠ¼ä¸‹ã§ 0.0s ã‹ã‚‰å†ç”Ÿé–‹å§‹ã—ã€ç›£è¦–ã§ 0.0ã€œ1.0s ã‚’ãƒ«ãƒ¼ãƒ—
  // å…ˆã« currentTime ã‚’åˆã‚ã›ã¦ã‹ã‚‰ playï¼ˆãƒ¢ãƒã‚¤ãƒ«äº’æ›ï¼‰
  try { video.currentTime = LOOP_START; } catch(_){}
  video.play().catch(()=>{});
  startLoopGuard();
  if (!rafId) draw();
}

function pressEnd(){
  if (!holding) return;
  holding = false;
  playingTail = true;
  shouldShowFortune=true;

  // ãƒ«ãƒ¼ãƒ—çµ‚äº†ï¼š1.0s ä½ç½®ã«é€ã‚Šã€ãã“ã‹ã‚‰æœ€å¾Œã¾ã§æœ¬å†ç”Ÿ
  try {
    if (video.currentTime < LOOP_END - LOOP_EPS || video.currentTime > LOOP_END + 0.2) {
      video.currentTime = LOOP_END;
    }
  } catch(_){}
  video.play().catch(()=>{});
}

video.addEventListener('ended', () => {
  if (shouldShowFortune) { showFortune(); shouldShowFortune=false; }
  playingTail = false;

  // æ¬¡ã®æ“ä½œã«å‚™ãˆã¦æç”»ãƒ«ãƒ¼ãƒ—ã¯ç¶­æŒã€å‹•ç”»ã¯åœæ­¢çŠ¶æ…‹
});

/* ===== ãƒ›ãƒãƒ¼æ¡ˆå†… ===== */
stageWrap.addEventListener('mouseenter', ()=> hoverHint && (hoverHint.style.display='block'));
stageWrap.addEventListener('mouseleave', ()=> hoverHint && (hoverHint.style.display='none'));
canvas.addEventListener('touchstart', ()=> hoverHint && (hoverHint.style.display='none'), {passive:true});

/* ===== ã‚¤ãƒ™ãƒ³ãƒˆç™»éŒ² ===== */
canvas.addEventListener('mousedown', e => { e.preventDefault(); pressStart(); });
window.addEventListener('mouseup',   e => { e.preventDefault(); pressEnd(); });
canvas.addEventListener('touchstart', e => { e.preventDefault(); pressStart(); }, {passive:false});
window.addEventListener('touchend',   e => { e.preventDefault(); pressEnd(); },   {passive:false});

/* ===== åˆæœŸæç”»é–‹å§‹ ===== */
video.addEventListener('loadeddata', () => {
  // iOSãªã©ã§ã®ã‚¹ã‚¿ãƒ¼ãƒˆå®‰å®šåŒ–
  video.muted = true;
  if (!rafId) draw();
});
setTimeout(()=>{ if (!rafId) draw(); }, 1200);
</script>
</body>
</html>


